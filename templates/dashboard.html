{% extends 'base.html' %}

{% block title %}Dashboard - VulnHunter{% endblock %}

{% block content %}
<div class="bg-gray-800 p-8 rounded-lg shadow-2xl max-w-2xl mx-auto">
    <h2 class="text-3xl font-bold mb-6 text-center text-cyan-300">Start a New Scan</h2>
    
    <form id="scan-form">
        <div class="mb-4">
            <label for="target_url" class="block text-sm font-medium text-gray-300 mb-2">Target URL</label>
            <input type="text" name="target_url" id="target_url" 
                   class="w-full p-3 bg-gray-700 border border-gray-600 rounded-md focus:ring-cyan-500 focus:border-cyan-500 text-white" 
                   placeholder="example.com" required>
        </div>
        
        <button type="submit" id="scan-button"
                class="w-full bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-4 rounded-md transition duration-300">
            Scan Now
        </button>
    </form>
    
    <div id="progress-section" class="mt-6 hidden">
        <p id="progress-text" class="text-center text-gray-300 mb-2">Starting scan...</p>
        <div class="w-full bg-gray-700 rounded-full h-4">
            <div id="progress-bar" class="bg-cyan-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
    </div>
</div>


<div class="mt-12">
    <h3 class="text-2xl font-bold mb-4 text-center">Scan History</h3>
    <div class="bg-gray-800 p-1 rounded-lg shadow-lg">
        <table class="min-w-full">
            <thead class="bg-gray-700">
                <tr>
                    <th class="p-4 text-left text-sm font-semibold text-gray-300">Target URL</th>
                    <th class="p-4 text-left text-sm font-semibold text-gray-300">Scan Date</th>
                    <th class="p-4 text-left text-sm font-semibold text-gray-300">Status</th>
                    <th class="p-4 text-left text-sm font-semibold text-gray-300">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-700">
                {% for scan in scans %}
                <tr class="hover:bg-gray-700">
                    <td class="p-4 whitespace-nowrap">{{ scan.target_url }}</td>
                    <td class="p-4 whitespace-nowrap">{{ scan.scan_date | to_ist }}</td>
                    <td class="p-4 whitespace-nowrap">
                        {% if scan.status == 'Completed' %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-500 text-green-900">
                                {{ scan.status }}
                            </span>
                        {% else %}
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-500 text-yellow-900 animate-pulse">
                                {{ scan.status }}
                            </span>
                        {% endif %}
                    </td>
                    <td class="p-4 whitespace-nowrap">
                        <a href="{{ url_for('scan_details', scan_id=scan.id) }}" class="inline-flex items-center bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-3 rounded-md transition duration-300">
                            View Details
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 ml-2">
                            <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.28a.75.75 0 011.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                            </svg>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    const scanForm = document.getElementById('scan-form');
    const scanButton = document.getElementById('scan-button');
    const progressSection = document.getElementById('progress-section');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');

    scanForm.addEventListener('submit', async function(event) {
        event.preventDefault(); // Stop the form from reloading the page
        
        scanButton.disabled = true;
        scanButton.textContent = 'Scanning...';
        progressSection.classList.remove('hidden');

        const formData = new FormData(scanForm);
        
        // Start the scan by sending the form data to our main route
        const startResponse = await fetch("{{ url_for('dashboard') }}", {
            method: 'POST',
            body: formData,
        });
        
        const data = await startResponse.json();
        const scanId = data.scan_id;

        // Start polling for status updates
        const intervalId = setInterval(async () => {
            const statusResponse = await fetch(`/scan_status/${scanId}`);
            const statusData = await statusResponse.json();

            // Update the UI
            progressText.textContent = statusData.status;
            progressBar.style.width = statusData.progress + '%';

            if (statusData.status === 'Completed') {
                clearInterval(intervalId); // Stop polling
                progressText.textContent = 'Scan completed! Reloading page...';
                
                // Reload the page to show the final results in the table
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }, 2000); // Poll every 2 seconds
    });
</script>
{% endblock %}